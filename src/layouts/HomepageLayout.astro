---
const { title = 'UMKMotion', description = '' } = Astro.props;
import FloatingAIButton from '@/components/FloatingAIButton';
---

<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <!-- CRITICAL: Define __publicField FIRST before any other scripts -->
    <script is:inline type="text/javascript">
      // CRITICAL: This must run before any React/vendor code loads
      // Always override any existing version with our safe implementation
      (function() {
        'use strict';
        // Safe __publicField implementation that handles undefined/null objects
        function safePublicField(obj, key, value) {
          // Safely handle undefined/null objects - return early to prevent errors
          if (obj == null || typeof obj !== 'object') {
            return value;
          }
          try {
            Object.defineProperty(obj, key, {
              enumerable: true,
              configurable: true,
              writable: true,
              value: value
            });
          } catch (e) {
            // Fallback: try direct assignment if defineProperty fails
            if (obj != null && typeof obj === 'object') {
              try {
                obj[key] = value;
              } catch (e2) {
                // Silently fail if both methods fail
              }
            }
          }
          return value;
        }
        
        // Override __publicField everywhere - always use our safe version
        var __publicField = safePublicField;
        
        // Attach to all possible global contexts
        try { window.__publicField = __publicField; } catch (e) {}
        try { self.__publicField = __publicField; } catch (e) {}
        try { globalThis.__publicField = __publicField; } catch (e) {}
        try { if (typeof global !== 'undefined') global.__publicField = __publicField; } catch (e) {}
        
        // Create bare identifier in global scope for direct references
        try {
          (0, eval)("var __publicField = (function(obj, key, value) { if (obj == null || typeof obj !== 'object') return value; try { Object.defineProperty(obj, key, { enumerable: true, configurable: true, writable: true, value: value }); } catch { if (obj != null) obj[key] = value; } return value; });");
        } catch (e) {}
        
        // CRITICAL: Re-apply safe version after vendor scripts load
        // This ensures bundled vendor code uses our safe version
        var reapplySafeVersion = function() {
          try {
            var safe = safePublicField;
            // Override again in case vendor code overwrote it
            window.__publicField = safe;
            self.__publicField = safe;
            globalThis.__publicField = safe;
            if (typeof global !== 'undefined') global.__publicField = safe;
            // Re-create bare identifier multiple times to ensure it sticks
            try {
              (0, eval)("var __publicField = (function(obj, key, value) { if (obj == null || typeof obj !== 'object') return value; try { Object.defineProperty(obj, key, { enumerable: true, configurable: true, writable: true, value: value }); } catch { if (obj != null) obj[key] = value; } return value; });");
            } catch (e) {}
            // Also try to make it non-configurable to prevent overwrites
            try {
              Object.defineProperty(window, '__publicField', {
                value: safe,
                writable: false,
                configurable: false,
                enumerable: true
              });
            } catch (e) {
              // If that fails, at least keep it writable
              try { window.__publicField = safe; } catch (e2) {}
            }
          } catch (e) {}
        };
        
        // Re-apply immediately and also after DOM loads
        reapplySafeVersion();
        if (typeof document !== 'undefined') {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', reapplySafeVersion);
          }
          window.addEventListener('load', reapplySafeVersion);
        }
        // Also re-apply after delays to catch late-loading scripts
        setTimeout(reapplySafeVersion, 0);
        setTimeout(reapplySafeVersion, 50);
        setTimeout(reapplySafeVersion, 100);
        setTimeout(reapplySafeVersion, 250);
        setTimeout(reapplySafeVersion, 500);
        setTimeout(reapplySafeVersion, 1000);
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://app.sandbox.midtrans.com https://*.midtrans.com https://*.gstatic.com https://*.google.com https://fonts.googleapis.com;
      frame-src 'self' blob: https://app.sandbox.midtrans.com https://*.midtrans.com https://*.firebaseapp.com https://*.google.com https://*.gstatic.com https://accounts.google.com https://apis.google.com;
      connect-src 'self' https://app.sandbox.midtrans.com https://api.sandbox.midtrans.com https://*.midtrans.com https://*.googleapis.com https://fonts.googleapis.com https://fonts.gstatic.com;
      img-src 'self' data: blob: https:;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com 'unsafe-hashes';
      font-src 'self' https://fonts.gstatic.com data:;
      child-src 'self' https://app.sandbox.midtrans.com https://*.midtrans.com;
      form-action 'self' https://app.sandbox.midtrans.com;
    "/>
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
  </head>
  <body class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-sky-50 text-slate-900 antialiased">
    <div class="relative min-h-screen flex flex-col">
      <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-slate-200">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
          <slot name="header" />
        </div>
      </header>

      <main class="flex-1">
        <slot />
      </main>

      <footer class="border-t border-slate-200 bg-white/70 backdrop-blur">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
          <slot name="footer" />
        </div>
      </footer>

      <FloatingAIButton client:idle />
    </div>
  </body>
</html>
